<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
   
    <link rel="stylesheet" href="/css/createpurchasestyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    
    
</head>
<body>
   <section class="header">
    <div class="logo">
        <i class="fa-solid fa-bars icon icon0 menu"></i>
        <h2>POS</h2>
    </div>
    <div class="search-notification-profile">
        <div class="search">
            <input type="text" placeholder="search here">
            <button><i class="fa-solid fa-magnifying-glass"></i></button>
        </div>

        <div class="notification-profile">
            <div class="picon scan">
                <button>scan</button>
            </div>
            <div class="picon pos">
                <a href="#"><button>pos</button></a>
            </div>
            <div class="picon bell">
                <i class="fa-solid fa-bell"></i>
            </div>
            <div class="picon profile" onclick="toggledropdown()">
                <i class="fa-solid fa-user"></i>
            </div>
            <div class="dropdown" id="dropdowns">
                
                <div class="profilecard">
                    <div class="cardborder">
                        <img src="#" alt="profile image" class="cardimage">
                        
                    </div>
                    
                    <div class="settingandlogout">
                        <div class="settings">
                            <a href="#"><i class="fa-solid fa-gear"></i></a>
                        </div>
                        <div class="logouts">
                            <a href="#"><i class="fa-solid fa-right-from-bracket"></i></a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
   </section>
   
   
   <section class="main">
    
    <div class="sidebar">
        <ul class="sidebar-top-item">
            <li>
                <a href="/index" id="active">
                    <span class="icon icon1"><i class="fa-solid fa-house"></i></span>
                    <span class="item">dashboard</span>
                </a>
            </li>
            <li >
                

                <a href="#" class="menuitem" >
                    
                    <span class="icon icon2"><i class="fa-solid fa-cart-shopping"></i></span>
                    <span class="item">purchase order</span>
                    <span class="icon arrow"><i class="fa-solid fa-angle-right"></i></span>
                    
                </a>
                <ul class="submenu">
                    <a href="/purchase/list">purchase list</a>
                    <a href="/purchase/create">create purchase</a>
                    <a href="#">manage purchase invoice</a>
                    <a href="#">purchase return</a>
                </ul>
            </li>
            <li>
                <a href="#" class="menuitem">
                    <span class="icon icon3"><i class="fa-solid fa-sack-dollar"></i></span>
                    <span class="item">sale transaction</span>
                    <span class="icon arrow"><i class="fa-solid fa-angle-right"></i></span>
                </a>
                <ul class="submenu">
                    <a href="#">sale list</a>
                    <a href="#">pos</a>
                    <a href="#">manage sale invoice</a>
                    <a href="#">sale return</a>
                </ul>
                
            </li>
            <li>
                <a href="#" class="menuitem">
                    <span class="icon icon4"><i class="fa-solid fa-box-open"></i></span>
                    <span class="item">inventory</span>
                    <span class="icon arrow"><i class="fa-solid fa-angle-right"></i></span>
                </a>
                <ul class="submenu">
                    <a href="#">product list</a>
                    
                </ul>
            </li>
            <li>
                <a href="#" class="menuitem">
                    <span class="icon icon5"><i class="fa-solid fa-users"></i></span>
                    <span class="item">vendor</span>
                    <span class="icon arrow"><i class="fa-solid fa-angle-right"></i></span>
                </a>
                <ul class="submenu">
                    <a href="#">vendor list</a>
                    <a href="#">create new vendor</a>
                    <a href="#">cash payment</a>
                </ul>
            </li>
            <li>
                <a href="#">
                    <span class="icon icon6"><i class="fa-solid fa-chart-line"></i></span>
                    <span class="item">report</span>
                    
                </a>
            </li>
        </ul>
        <ul class="sidebar-bottom-item">
            <li>
                <a href="#">
                    <span class="icon icon7"><i class="fa-solid fa-gear"></i></span>
                    <span class="item">setting</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <span class="icon icon8"><i class="fa-solid fa-right-from-bracket"></i></span>
                    <span class="item">logout</span>
                </a>
            </li>
        </ul>
    </div>
    
    
    <div class="maincontent">
        <h1>Create Purchase</h1>
    <form id="purchaseForm" method="post">
        <label for="invoiceNumber">Invoice Number:</label>
        <input type="text" id="invoiceNumber" name="invoiceNumber" required>

        <label for="vendorSelect">Vendor:</label>
        <select id="vendorSelect" name="vendor" required>
            <option value="">Select Vendor</option>
            <!-- Vendor options will be populated dynamically -->
        </select>

        <label for="currentDate">Current Date:</label>
        <input type="date" id="currentDate" name="currentDate" required>

        <h2>Product Details</h2>
        <table id="productTable">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>MRP Unit</th>
                    <th>Purchase Unit</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="productBody">
                <!-- Dynamic rows will be added here -->
            </tbody>
        </table>
        <button type="button" id="addProductButton">Add Product</button>
        <button type="button" id="clearFormButton">Clear All</button>

        <h3>Total Amount: <span id="totalAmount">0</span></h3>

   

    
        <button type="submit">Submit</button>
       
        
    </form>

    <!-- Popup Modal -->
    <div id="popup" class="popup" style="display:none;">
        <div class="popup-content">
            <span class="close">&times;</span>
            <p>Purchase submitted successfully!</p>
             <!--invoice button-->
            <button type="button" id="generateInvoiceButton">Generate Invoice</button>
        </div>
    </div>

    

    <script>
        let productCount = 0;
        let products = []; // Array to hold product data
        let vendors = []; // Array to hold vendor data

        async function fetchProducts() {
            try {
                const response = await fetch('/purchase/products');
                if (!response.ok) throw new Error('Failed to fetch products');
                products = await response.json();
                console.log('Fetched products:', products);
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }

        async function fetchVendors() {
            try {
                const response = await fetch('/purchase/vendors');
                if (!response.ok) throw new Error('Failed to fetch vendors');
                vendors = await response.json();
                console.log('Fetched vendors:', vendors);
                populateVendorSelect();
            } catch (error) {
                console.error('Error fetching vendors:', error);
            }
        }

        function populateVendorSelect() {
            const vendorSelect = document.getElementById('vendorSelect');
            vendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor.vendor_id;
                option.textContent = vendor.vendor_name;
                vendorSelect.appendChild(option);
            });
        }

        window.onload = async () => {
            await fetchProducts();
            await fetchVendors();
        };

        document.getElementById('addProductButton').addEventListener('click', () => {
            productCount++;
            const productBody = document.getElementById('productBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${productCount}</td>
                <td><input type="text" class="productId" readonly></td>
                <td>
                    <select class="productSelect" onchange="updateProductDetails(this)">
                        <option value="">Select Product</option>
                        ${products.map(product => `<option value="${product.product_id}">${product.product_name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" class="quantity" value="1" oninput="updateTotal()"></td>
                <td><input type="text" class="mrpUnit" readonly></td>
                <td><input type="number" class="purchaseUnit" oninput="updateTotal()"></td>
                <td><button type="button" onclick="removeRow(this)">Delete</button></td>
            `;
            productBody.appendChild(newRow);
            updateTotal();
        });

        function updateProductDetails(select) {
            const row = select.closest('tr');
            const productIdCell = row.querySelector('.productId');
            const mrpUnitCell = row.querySelector('.mrpUnit');
            const selectedId = select.value;

            const product = products.find(p => p.product_id == selectedId);
            if (product) {
                productIdCell.value = product.product_id;
                mrpUnitCell.value = product.unit_price; // Assuming unit_price is the MRP unit
            } else {
                productIdCell.value = '';
                mrpUnitCell.value = '';
            }
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            const rows = document.querySelectorAll('#productBody tr');
            rows.forEach(row => {
                const quantity = row.querySelector('.quantity').value || 0;
                const purchaseUnit = row.querySelector('.purchaseUnit').value || 0;
                total += quantity * purchaseUnit;
            });
            document.getElementById('totalAmount').innerText = total;
        }

        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
            updateSerialNumbers();
            updateTotal();
        }

        function updateSerialNumbers() {
            const rows = document.querySelectorAll('#productBody tr');
            rows.forEach((row, index) => {
                row.cells[0].innerText = index + 1; // Update S.No
            });
            productCount = rows.length; // Update productCount if needed
        }

        document.getElementById('clearFormButton').addEventListener('click', () => {
            document.getElementById('purchaseForm').reset();
            document.getElementById('productBody').innerHTML = '';
            updateTotal();
        });

        document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const vendorId = document.getElementById('vendorSelect').value;
            const orderDate = document.getElementById('currentDate').value;
            const totalAmount = document.getElementById('totalAmount').innerText;

            const items = Array.from(document.querySelectorAll('#productBody tr')).map(row => {
                return {
                    product_id: row.querySelector('.productSelect').value,
                    qty: row.querySelector('.quantity').value,
                    purchaseRate_per_unit: row.querySelector('.purchaseUnit').value
                };
            });

            try {
                const response = await fetch('/purchase/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        po_id: invoiceNumber,
                        vendor_id: vendorId,
                        orderdate: orderDate,
                        total_amount: totalAmount,
                        items: items
                    })
                });

                if (!response.ok) throw new Error('Failed to submit purchase order');

                document.getElementById('popup').style.display = 'block'; // Show popup
            } catch (error) {
                console.error('Error submitting purchase order:', error);
                alert('Failed to submit purchase order.');
            }
        });

        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('purchaseForm').reset();
            document.getElementById('productBody').innerHTML = '';
            updateTotal();
        });
        /*---------------------------------------------------invoice scripts */
        document.getElementById('generateInvoiceButton').addEventListener('click', async () => {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
    
            if (!invoiceNumber) {
                alert('Please submit the purchase order first.');
                return;
            }
    
            try {
                const response = await fetch(`/invoice/${invoiceNumber}`, { method: 'POST' });
                if (response.ok) {
                    // Open the PDF in a new tab
                    //window.open(`/invoice/${invoiceNumber}`, '_blank');
                    //---------------------------------instead of oppening in the new tab
                    const fileBlob = await response.blob(); // Get the PDF as a Blob

                    // Create a temporary URL for the Blob
                    const fileUrl = URL.createObjectURL(fileBlob);

                    // Create an anchor element to trigger the download
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = `invoice_${invoiceNumber}.pdf`; // You can set a custom filename for the download
                    document.body.appendChild(link); // Append the link to the body (not visible)
                    link.click(); // Trigger the download
                    document.body.removeChild(link); // Remove the link after the download is triggered

                    window.open(fileUrl, '_blank');

                } else {
                    const errorText = await response.text();
                    console.error('Error:', errorText);
                    console.error('Status Code:', response.status); // Log the status code
                    //alert('Failed to generate invoice.');
                    alert(`Failed to generate invoice. Status Code: ${response.status}`);
                }
            } catch (error) {
                console.error('Error generating invoice:', error);
                alert('An error occurred while generating the invoice.');
            }
        });


        /*end of invoice scripts-------------------------------------------------------------*/




    </script>

    

    <style>
        .popup {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .popup-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            text-align: center;
        }
        .close {
            cursor: pointer;
            float: right;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
        
    </div>
   </section>
   <script src="/js/createpurchase.js"></script>
</body>
</html>